# 设备抽象模型

| Version | Date | Editor | Note |
| :-----| ----: | :----: |:----: |
| v0.0.5 | 2020-05-28 | zhangte | 定义设备抽象模型初版|

## TODO List:
- [ ] SN生成规则定义(包含型号和UUID)，9位
- [ ] SKUID生成规则定义
## 设备端标识
#### 组成
1. SN(Serial Number),设备唯一的随机序列号，由服务端根据一定规则生成，SN将作为CSoD协议中设备唯一标识使用
2. SKU(Stock Keeping Unit), 设备唯一的最小库存单元号，与SN一一对应，但是其直观保留生产日期、批次等信息，用作库存管理
3. MAC, 模块自带
4. 型号, 表明设备型号
## 设备端能力抽象与寻址
考虑到不同型号的设备端具有不同模组组成的不同端能力，并且服务端需要对不同的模组完成准确的控制，我们按照 **"端单元"**（unit）来描述设备能力
1. 每个最小不可分功能作为一个单元，如一个开关，一个温度模块，一个湿度模块，一个显示屏
2. 每个端单元都有唯一的地址，端单元地址共3位，以十六进制字符串表示，前2位表示单元类型，后1位表示单元id, 每个单元地址对应一个状态`status`

目前定义三类端单元及其`status`如下:
```
开关: "01${id}",  对应status: {1byte}, 关: 00, 开: 01
温度: "02${id}",  对应status: {1byte}{1bytes}{1bytes}  第1位符号，中间1位整数部分，后1位小数部分
湿度: "03${id}",  对应status: {1byte}{1bytes}{1bytes}  第1位符号，中间1位整数部分，后1位小数保留2位部分(最大0x63)
开关定时器:"04${id}", 对应status: {"date":"y-m-d:h-m-s", "target":"${开关状态}"}
延时开关: "05${id}", 对应status: {"delay":${time}, "target": "${开关状态}"},延时单位为秒
```
例如结合CSoD协议event消息：
```json
设备上报状态，在`sn`为`123543876`的设备上，`0`号开关状态为`开`，`2`号温度计温度为`+10.10℃`
{
	"v":"0",
	"type": "event",
	"sn": "123543876",                    
	"010": "01",
	"022": "000a0a",
}
```
```json
APP设置定时开关，在`sn`为`123543876`的设备上，定时在2020-11-12:12-30-00, `0`号开关状态为`开`
{
	"v":"0",
	"type": "set",
	"sn": "123543876",                    
	"010": "01",
	"040": {
		"date": "2020-11-12:12-30-00",
		"target": "01"
	},
}

设置成功回复
{
	"v":"0",
	"type": "setack",
	"sn": "123543876",
}
```

```json
APP延时开关，在`sn`为`123543876`的设备上，100s后, 设置`0`号开关状态为`开`
{
	"v":"0",
	"type": "set",
	"sn": "123543876",                    
	"010": "01",
	"050": {
		"delay": "100",
		"target": "01"
	},
}

设置成功回复
{
	"v":"0",
	"type": "setack",
	"sn": "123543876",
}
```
